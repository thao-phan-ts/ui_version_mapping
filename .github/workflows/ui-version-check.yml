name: UI Version Check Tool

on:
  workflow_dispatch:
    inputs:
      lead_source:
        description: 'Lead Source'
        required: true
        type: choice
        options:
          - organic
          - evo_native
          - win
          - winback
        default: 'organic'
      
      config_path:
        description: 'Config Path (evo, win, evo_native, winback)'
        required: true
        type: choice
        options:
          - evo
          - win
          - evo_native
          - winback
        default: 'evo'
      
      lender_config_id:
        description: 'Lender Config ID'
        required: true
        type: string
        default: '9054'
      
      workflow_mode:
        description: 'Analysis Mode'
        required: true
        type: choice
        options:
          - complete
          - ab-testing
          - journey
        default: 'complete'

jobs:
  ui-version-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Set up Java (for PlantUML)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('go.sum', 'go.mod') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Download dependencies
      run: go mod download
    
    - name: Setup Sample Configuration Data
      run: |
        echo "🔧 Setting up sample configuration data..."
        mkdir -p vendor/configs/evo
        
        # Create sample configuration files for testing
        cat > vendor/configs/evo/9054_organic.json << 'CONFIG_EOF'
        {
          "id": 9054,
          "name": "v1.0.collect.organic",
          "tags": [
            {"name": "lead_source", "value": "organic"},
            {"name": "flow_type", "value": "collect"}
          ],
          "ui_version": "v9.1.5.0",
          "ui_flow": [
            "otp",
            "app_form.basic_info",
            "ekyc.selfie.active",
            "inform.success",
            "esign.review"
          ],
          "ui_flow_settings": {},
          "weight": 100
        }
        CONFIG_EOF
        
        cat > vendor/configs/evo/9012_organic.json << 'CONFIG_EOF'
        {
          "id": 9012,
          "name": "v1.0.diff_nation_id",
          "tags": [
            {"name": "lead_source", "value": "organic"},
            {"name": "flow_type", "value": "diff_nation_id"}
          ],
          "ui_version": "v9.1.4.0",
          "ui_flow": [
            "otp",
            "app_form.basic_info",
            "ekyc.selfie.active"
          ],
          "ui_flow_settings": {},
          "weight": 50
        }
        CONFIG_EOF
        
        echo "✅ Sample configuration created"
        echo "📁 Vendor configs:"
        find vendor/configs -name "*.json" | head -10
    
    - name: Build UI Version Check Tool
      run: |
        make build
        chmod +x bin/ui-version-check
    
    - name: Run UI Version Analysis
      run: |
        echo "🚀 Starting UI Version Analysis..."
        echo "=================================="
        echo "Lead Source: ${{ github.event.inputs.lead_source }}"
        echo "Config Path: ${{ github.event.inputs.config_path }}"
        echo "Lender Config ID: ${{ github.event.inputs.lender_config_id }}"
        echo "Workflow Mode: ${{ github.event.inputs.workflow_mode }}"
        echo ""
        
        # Create output directory
        mkdir -p ./results
        echo "📁 Created output directory: ./results"
        
        # Run analysis
        echo "🔧 Running analysis command..."
        ./bin/ui-version-check \
          -config ${{ github.event.inputs.lender_config_id }} \
          -lead-source ${{ github.event.inputs.lead_source }} \
          -config-path ${{ github.event.inputs.config_path }} \
          -mode ${{ github.event.inputs.workflow_mode }} \
          -output ./results
        
        echo "✅ Analysis completed successfully!"
    
    - name: Upload Analysis Results
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('results/**/*') != ''
      with:
        name: ui-version-analysis-results-${{ github.event.inputs.lender_config_id }}-${{ github.event.inputs.lead_source }}
        path: |
          results/
          !results/**/*.jar
        retention-days: 30
    
    - name: Display Results Summary
      if: always()
      run: |
        echo "📊 Analysis Results Summary"
        echo "=========================="
        echo "Configuration: ${{ github.event.inputs.lender_config_id }} (${{ github.event.inputs.lead_source }})"
        echo "Mode: ${{ github.event.inputs.workflow_mode }}"
        echo "Config Path: ${{ github.event.inputs.config_path }}"
        echo ""
        
        if [ -d "results/${{ github.event.inputs.lender_config_id }}" ]; then
          echo "✅ Analysis completed successfully!"
          echo ""
          echo "📁 Generated Files:"
          find results/${{ github.event.inputs.lender_config_id }} -type f | head -20
          echo ""
          echo "💾 Download the 'ui-version-analysis-results-${{ github.event.inputs.lender_config_id }}-${{ github.event.inputs.lead_source }}' artifact to get all generated files"
        else
          echo "❌ Analysis failed or no results generated for config ${{ github.event.inputs.lender_config_id }}"
          echo "Check the logs above for error details"
        fi
