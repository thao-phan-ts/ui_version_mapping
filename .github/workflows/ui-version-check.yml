name: UI Version Check Tool

on:
  workflow_dispatch:
    inputs:
      lead_source:
        description: 'Lead Source (e.g., organic, evo_native, mwg_pos, seller_general)'
        required: true
        type: string
        default: 'organic'
      
      config_path:
        description: 'Config Path (evo, win, evo_native, winback)'
        required: true
        type: choice
        options:
          - evo
          - win
          - evo_native
          - winback
        default: 'evo'
      
      lender_config_id:
        description: 'Lender Config ID'
        required: true
        type: string
        default: '9054'
      
      workflow_mode:
        description: 'Analysis Mode'
        required: true
        type: choice
        options:
          - complete
          - ab-testing
          - journey
        default: 'complete'
      
      digital_journey_version:
        description: 'Digital Journey Version (branch/tag/commit)'
        required: false
        type: string
        default: 'master'
      
      decision_engine_version:
        description: 'Decision Engine Version (branch/tag/commit)'
        required: false
        type: string
        default: 'master'

jobs:
  ui-version-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
        cache: false
    
    - name: Set up Java (for PlantUML)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Download dependencies
      run: go mod download
    
    - name: Setup Repository Dependencies
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TS_TOKEN_TEST: ${{ secrets.TS_TOKEN_TEST }}
        TSOCIAL_ACCESS_TOKEN: ${{ secrets.TSOCIAL_ACCESS_TOKEN }}
      run: |
        echo "ðŸ”„ Setting up repository dependencies..."
        
        # Check if auto_sync.sh exists
        if [ -f "auto_sync.sh" ]; then
          echo "ðŸ“¦ Preparing to run auto_sync.sh..."
          
          # Make script executable
          chmod +x auto_sync.sh
          
          # Set versions from environment or use defaults
          export DIGITAL_JOURNEY_VERSION="${{ github.event.inputs.digital_journey_version || 'master' }}"
          export DECISION_ENGINE_VERSION="${{ github.event.inputs.decision_engine_version || 'master' }}"
          
          echo "  â€¢ Digital Journey Version: $DIGITAL_JOURNEY_VERSION"
          echo "  â€¢ Decision Engine Version: $DECISION_ENGINE_VERSION"
          
          # Show token status (masked)
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            echo "  â€¢ GITHUB_TOKEN: Available (${#GITHUB_TOKEN} chars)"
          else
            echo "  â€¢ GITHUB_TOKEN: Not available"
          fi
          
          if [ -n "${TS_TOKEN_TEST:-}" ]; then
            echo "  â€¢ TS_TOKEN_TEST: Available (${#TS_TOKEN_TEST} chars)"
          else
            echo "  â€¢ TS_TOKEN_TEST: Not available"
          fi
          
          if [ -n "${TSOCIAL_ACCESS_TOKEN:-}" ]; then
            echo "  â€¢ TSOCIAL_ACCESS_TOKEN: Available (${#TSOCIAL_ACCESS_TOKEN} chars)"
          else
            echo "  â€¢ TSOCIAL_ACCESS_TOKEN: Not available"
          fi
          
          # Run auto_sync.sh with initialization
          ./auto_sync.sh 1 || {
            echo "âš ï¸ auto_sync.sh failed, continuing with fallback configs..."
          }
          
          # Check if configs were fetched
          if [ -d "submodules/digital_journey/migration" ]; then
            echo "âœ… Repository configs fetched successfully"
            
            # Copy configs to vendor directory for consistency
            echo "ðŸ“‹ Copying configs to vendor directory..."
            mkdir -p vendor/configs
            if [ -d "submodules/digital_journey/migration/sync/vietnam/tpbank/lender_configs" ]; then
              cp -r submodules/digital_journey/migration/sync/vietnam/tpbank/lender_configs/* vendor/configs/ 2>/dev/null || true
              echo "âœ… Configs copied to vendor directory"
            fi
          else
            echo "âš ï¸ No configs fetched from repositories"
          fi
        else
          echo "âš ï¸ auto_sync.sh not found, skipping repository setup"
        fi
    
    - name: Setup Sample Configuration Data
      run: |
        echo "ðŸ”§ Setting up sample configuration data..."
        mkdir -p vendor/configs/evo
        
        # Create sample configuration files for testing
        cat > vendor/configs/evo/9054_organic.json << 'CONFIG_EOF'
        {
          "id": 9054,
          "name": "v1.0.collect.organic",
          "tags": [
            {"name": "lead_source", "value": "organic"},
            {"name": "flow_type", "value": "collect"}
          ],
          "ui_version": "v9.1.5.0",
          "ui_flow": [
            "otp",
            "app_form.basic_info",
            "ekyc.selfie.active",
            "inform.success",
            "esign.review"
          ],
          "ui_flow_settings": {},
          "weight": 100
        }
        CONFIG_EOF
        
        cat > vendor/configs/evo/9012_organic.json << 'CONFIG_EOF'
        {
          "id": 9012,
          "name": "v1.0.diff_nation_id",
          "tags": [
            {"name": "lead_source", "value": "organic"},
            {"name": "flow_type", "value": "diff_nation_id"}
          ],
          "ui_version": "v9.1.4.0",
          "ui_flow": [
            "otp",
            "app_form.basic_info",
            "ekyc.selfie.active"
          ],
          "ui_flow_settings": {},
          "weight": 50
        }
        CONFIG_EOF
        
        echo "âœ… Sample configuration created"
        echo "ðŸ“ Vendor configs:"
        find vendor/configs -name "*.json" | head -10
    
    - name: Build UI Version Check Tool
      run: |
        make build
        chmod +x bin/ui-version-check
    
    - name: Run UI Version Analysis
      id: analysis
      run: |
        echo "ðŸš€ Starting UI Version Analysis..."
        echo "=================================="
        echo "Lead Source: ${{ github.event.inputs.lead_source }}"
        echo "Config Path: ${{ github.event.inputs.config_path }}"
        echo "Lender Config ID: ${{ github.event.inputs.lender_config_id }}"
        echo "Workflow Mode: ${{ github.event.inputs.workflow_mode }}"
        echo ""
        
        # Create output directory
        mkdir -p ./results
        echo "ðŸ“ Created output directory: ./results"
        
        # Run analysis and capture output
        echo "ðŸ”§ Running analysis command..."
        echo "=================================="
        ./bin/ui-version-check \
          -config ${{ github.event.inputs.lender_config_id }} \
          -lead-source ${{ github.event.inputs.lead_source }} \
          -config-path ${{ github.event.inputs.config_path }} \
          -mode ${{ github.event.inputs.workflow_mode }} \
          -output ./results | tee analysis_output.txt
        
        echo ""
        echo "âœ… Analysis completed successfully!"
    
    - name: Upload Analysis Results
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('results/**/*') != ''
      with:
        name: ui-version-analysis-results-${{ github.event.inputs.lender_config_id }}-${{ github.event.inputs.lead_source }}
        path: |
          results/
          !results/**/*.jar
        retention-days: 30
    
    - name: Display Results Summary
      if: always()
      run: |
        echo "ðŸ“Š Analysis Results Summary"
        echo "=========================="
        echo "Configuration: ${{ github.event.inputs.lender_config_id }} (${{ github.event.inputs.lead_source }})"
        echo "Mode: ${{ github.event.inputs.workflow_mode }}"
        echo "Config Path: ${{ github.event.inputs.config_path }}"
        echo ""
        
        # Display the analysis output
        if [ -f "analysis_output.txt" ]; then
          echo "ðŸ“‹ Analysis Output:"
          echo "-------------------"
          cat analysis_output.txt
          echo ""
        fi
        
        # Check for generated files
        if [ -d "results/${{ github.event.inputs.lender_config_id }}" ]; then
          echo "âœ… Analysis completed with generated files!"
          echo ""
          echo "ðŸ“ Generated Files:"
          find results/${{ github.event.inputs.lender_config_id }} -type f | head -20
          echo ""
          
          # Display summary report if it exists
          SUMMARY_FILE="results/${{ github.event.inputs.lender_config_id }}/summary_report_${{ github.event.inputs.lender_config_id }}_${{ github.event.inputs.lead_source }}.md"
          if [ -f "$SUMMARY_FILE" ]; then
            echo "ðŸ“„ Summary Report:"
            echo "=================="
            cat "$SUMMARY_FILE"
            echo ""
          fi
          
          # Display JSON results preview for different modes
          if [ "${{ github.event.inputs.workflow_mode }}" = "ab-testing" ] || [ "${{ github.event.inputs.workflow_mode }}" = "complete" ]; then
            AB_FILE="results/${{ github.event.inputs.lender_config_id }}/ab_testing_analysis_${{ github.event.inputs.lender_config_id }}_${{ github.event.inputs.lead_source }}.json"
            if [ -f "$AB_FILE" ]; then
              echo "ðŸ”¬ A/B Testing Results Preview:"
              echo "--------------------------------"
              head -n 50 "$AB_FILE" | jq '.' 2>/dev/null || head -n 50 "$AB_FILE"
              echo ""
            fi
          fi
          
          if [ "${{ github.event.inputs.workflow_mode }}" = "journey" ] || [ "${{ github.event.inputs.workflow_mode }}" = "complete" ]; then
            JOURNEY_FILE="results/${{ github.event.inputs.lender_config_id }}/journey_analysis_${{ github.event.inputs.lender_config_id }}_${{ github.event.inputs.lead_source }}.json"
            if [ -f "$JOURNEY_FILE" ]; then
              echo "ðŸ—ºï¸ Journey Analysis Results Preview:"
              echo "-------------------------------------"
              head -n 50 "$JOURNEY_FILE" | jq '.' 2>/dev/null || head -n 50 "$JOURNEY_FILE"
              echo ""
            fi
          fi
          
          echo "ðŸ’¾ Download the 'ui-version-analysis-results-${{ github.event.inputs.lender_config_id }}-${{ github.event.inputs.lead_source }}' artifact to get all generated files"
        else
          echo "âš ï¸ No additional files were generated in results directory"
          echo "The analysis output above shows what was discovered"
        fi
    
    - name: Create Job Summary
      if: always()
      run: |
        # Create GitHub Job Summary (displayed prominently in the Actions UI)
        echo "# ðŸ“Š UI Version Analysis Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Configuration" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Lender Config ID** | \`${{ github.event.inputs.lender_config_id }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Lead Source** | \`${{ github.event.inputs.lead_source }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Config Path** | \`${{ github.event.inputs.config_path }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Analysis Mode** | \`${{ github.event.inputs.workflow_mode }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Digital Journey Version** | \`${{ github.event.inputs.digital_journey_version || 'master' }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Decision Engine Version** | \`${{ github.event.inputs.decision_engine_version || 'master' }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add analysis output
        if [ -f "analysis_output.txt" ]; then
          echo "## ðŸ” Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat analysis_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add summary report if exists
        SUMMARY_FILE="results/${{ github.event.inputs.lender_config_id }}/summary_report_${{ github.event.inputs.lender_config_id }}_${{ github.event.inputs.lead_source }}.md"
        if [ -f "$SUMMARY_FILE" ]; then
          echo "## ðŸ“„ Detailed Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat "$SUMMARY_FILE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add file list
        if [ -d "results/${{ github.event.inputs.lender_config_id }}" ]; then
          echo "## ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following files were generated:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find results/${{ github.event.inputs.lender_config_id }} -type f -exec basename {} \; | sort | uniq >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download the artifact** \`ui-version-analysis-results-${{ github.event.inputs.lender_config_id }}-${{ github.event.inputs.lead_source }}\` to get all files" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Analysis completed at:** $(date)" >> $GITHUB_STEP_SUMMARY
