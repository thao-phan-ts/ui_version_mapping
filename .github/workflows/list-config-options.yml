name: List Configuration Options

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: 'Config Path to scan'
        required: true
        type: choice
        options:
          - evo
          - win
          - evo_native
          - winback
        default: 'evo'
      
      use_remote:
        description: 'Use Remote GitHub API'
        required: false
        type: boolean
        default: false
      
      repository_name:
        description: 'Repository containing configurations'
        required: false
        type: choice
        options:
          - tsocial/digital_journey
          - tsocial/decision_engine
        default: 'tsocial/digital_journey'

jobs:
  list-options:
    runs-on: ubuntu-latest
    # environment: production  # Commented out to use repository secrets instead
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Download dependencies
      run: go mod download
    
    - name: Setup Submodules
      run: |
        echo "ðŸ”§ Setting up submodules..."
        mkdir -p scripts/submodules
        
        # Clone digital_journey repository
        echo "Cloning digital_journey..."
        git clone https://github.com/tsocial/digital_journey.git scripts/submodules/digital_journey || {
          echo "Failed to clone digital_journey, trying with token..."
          git clone https://${{ secrets.TS_TOKEN || secrets.TSOCIAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}@github.com/tsocial/digital_journey.git scripts/submodules/digital_journey
        }
        
        # Clone decision_engine repository  
        echo "Cloning decision_engine..."
        git clone https://github.com/tsocial/decision_engine.git scripts/submodules/decision_engine || {
          echo "Failed to clone decision_engine, trying with token..."
          git clone https://${{ secrets.TS_TOKEN || secrets.TSOCIAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}@github.com/tsocial/decision_engine.git scripts/submodules/decision_engine
        }
        
        echo "âœ… Submodules setup complete"
        ls -la scripts/submodules/
    
    - name: Build UI Version Check Tool
      run: |
        make build
        chmod +x bin/ui-version-check
    
    - name: List Available Configuration Options
      run: |
        echo "ðŸ” Scanning Configuration Options..."
        echo "===================================="
        echo "Config Path: ${{ github.event.inputs.config_path }}"
        echo "Use Remote: ${{ github.event.inputs.use_remote }}"
        echo ""
        
        ./bin/ui-version-check -list-options -config-path ${{ github.event.inputs.config_path }} -remote=${{ github.event.inputs.use_remote }}
      env:
        GITHUB_TOKEN: ${{ secrets.TS_TOKEN || secrets.TSOCIAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        CONFIG_REMOTE_URL: https://api.github.com/repos/tsocial/digital_journey
    
    - name: Generate Options Summary
      run: |
        echo "ðŸ“‹ Configuration Options Summary" > options_summary.md
        echo "===============================" >> options_summary.md
        echo "" >> options_summary.md
        echo "**Config Path:** ${{ github.event.inputs.config_path }}" >> options_summary.md
        echo "**Source:** $([ '${{ github.event.inputs.use_remote }}' = 'true' ] && echo 'Remote GitHub API' || echo 'Local Files')" >> options_summary.md
        echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> options_summary.md
        echo "" >> options_summary.md
        
        # Capture the options output
        ./bin/ui-version-check -list-options -config-path ${{ github.event.inputs.config_path }} -remote=${{ github.event.inputs.use_remote }} >> options_summary.md 2>&1 || true
        
        echo "" >> options_summary.md
        echo "---" >> options_summary.md
        echo "" >> options_summary.md
        echo "ðŸ’¡ **How to use these options:**" >> options_summary.md
        echo "" >> options_summary.md
        echo "1. Go to the [UI Version Check workflow](../../actions/workflows/ui-version-check.yml)" >> options_summary.md
        echo "2. Click 'Run workflow'" >> options_summary.md
        echo "3. Select your desired Lead Source and enter a Lender Config ID from the list above" >> options_summary.md
        echo "4. Choose your analysis mode and run the workflow" >> options_summary.md
      env:
        GITHUB_TOKEN: ${{ secrets.TS_TOKEN || secrets.TSOCIAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        CONFIG_REMOTE_URL: https://api.github.com/repos/${{ github.event.inputs.repository_name }}
    
    - name: Upload Options Summary
      uses: actions/upload-artifact@v4
      with:
        name: config-options-${{ github.event.inputs.config_path }}
        path: options_summary.md
        retention-days: 7
    
    - name: Display Summary
      run: |
        echo "ðŸ“‹ Configuration Options Summary Generated"
        echo "========================================="
        cat options_summary.md 